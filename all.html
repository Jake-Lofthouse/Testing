<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>parkrunner tourist</title>
    <link rel="shortcut icon" type="image/x.icon" href="favicon.ico?">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-REFFZSK4XK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-REFFZSK4XK');
</script>



<!-- Cronitor RUM -->
<script async src="https://rum.cronitor.io/script.js"></script>
<script>
    window.cronitor = window.cronitor || function() { (window.cronitor.q = window.cronitor.q || []).push(arguments); };
    cronitor('config', { clientKey: '7d03d6af0f794abeb3988b05dc158a14' });
</script>

    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        
                /* Disable text selection for all elements except #search-container */
        *:not(#search-container) {
            user-select: none; /* Disable text selection */
            -webkit-user-select: none; /* Disable text selection in Safari */
            -ms-user-select: none; /* Disable text selection in Internet Explorer/Edge */
            -moz-user-select: none; /* Disable text selection in Firefox */
        }

        /* Disable dragging of images and links except #search-container */
        img:not(#search-container img), a:not(#search-container a) {
            -webkit-user-drag: none; /* Disable dragging in Safari */
            user-drag: none; /* Standard property */
        }
        
         * {
            user-select: none; /* Disable text selection */
            -webkit-user-select: none; /* Disable text selection in Safari */
            -ms-user-select: none; /* Disable text selection in Internet Explorer/Edge */
            -moz-user-select: none; /* Disable text selection in Firefox */
        }

        /* Disable dragging of images and links */
        img, a {
            -webkit-user-drag: none; /* Disable dragging in Safari */
            user-drag: none; /* Standard property */
        }
        

        .controls {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: -1;
        }
        .controls.hidden {
            display: none;
        }
        .controls label {
            display: flex;
            align-items: center;
            font-size: 16px;
        }
        .controls input[type="checkbox"] {
            accent-color: #007bff;
            margin-right: 10px;
            width: 20px;
            height: 20px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        .controls input[type="checkbox"]:checked {
            opacity: 1;
        }
        .hotel-btn, .course-btn, .volunteer-btn, .direction-btn {
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            text-align: center;
            text-decoration: none;
            box-sizing: border-box;
        }
        .hotel-btn {
            background-color: #6200ea;
        }
        .hotel-btn:hover {
            background-color: #4500b0;
        }
        
        .direction-btn {
            background-color: #d90b26;
        }
        .direction-btn:hover {
            background-color: #b71c1c;
        }
        
        .course-btn {
            background-color: #28a745;
        }
        .course-btn:hover {
            background-color: #218838;
        }
        .volunteer-btn {
            background-color: #e83e8c;
        }
        .volunteer-btn:hover {
            background-color: #d6336c;
        }
        .popup-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .leaflet-control-attribution {
            display: none;
        }
        #search-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
#search-icon {
    font-size: 21px;
    color: #333;
    cursor: pointer;
    transition: color 0.3s ease;
    background-color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
}

.hotel-popup button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
}


.location-button {
  position: absolute;
  top: 60px;
  right: 32px;
  z-index: 1000;
  background-color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.3);

  /* Flex properties to center both vertically and horizontally */
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: color 0.3s ease;
  padding: 0; /* Remove any padding */
}

/* Ensure the icon is centered */
.location-button i {
  font-size: 21px; /* Adjust as needed */
  line-height: 1; /* Reset line-height to remove any extra spacing */
  height: 100%; /* Take full height of the parent container */
  display: flex;
  align-items: center;
  justify-content: center;
}





        #search-input-container {
            position: relative;
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        #search-input {
            width: 0;
            opacity: 0;
            transition: width 0.3s ease, opacity 0.3s ease;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        

        #search-input.show {
            width: 40vw;
            max-width: 300px;
            opacity: 1;
        }
        #clear-btn {
            display: none;
            margin-left: 10px;
            background: none;
            border: none;
            cursor: pointer;
            color: #333;
            font-size: 16px;
        }

        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.5);
            z-index: 900;
            display: none;
            cursor: not-allowed;
        }
        
        #search-icon.hidden {
             display: none;
        }
        
/* Styles for hotel popup image */
.hotel-popup-image {
    max-width: 80%;      /* Slightly smaller width (80% of the popup) */
    height: auto;        /* Maintain aspect ratio */
    border-radius: 15px; /* Rounded corners */
    margin-bottom: 10px; /* Space between the image and the iframe */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for a modern look */
    transition: transform 0.3s ease; /* Smooth zoom effect on hover */
}

/* Image hover effect for a modern touch */
.hotel-popup-image:hover {
    transform: scale(1.05); /* Slight zoom-in effect when hovering */
}

/* Mapilly iframe container styling */
.mapilly-container {
    margin-bottom: 10px; /* Space between the iframe and the buttons */
}

/* Popup container for hotel details */
.hotel-popup {
    text-align: center; /* Center align text */
}

/* Buttons styles */
.hotel-popup button {
    width: 100%;        /* Full width buttons */
    padding: 10px 0;    /* Padding for buttons */
    margin: 5px 0;      /* Spacing for buttons */
    border: none;       /* Remove border */
    border-radius: 5px; /* Rounded corners */
    background-color: var(--button-color); /* Primary color using CSS variable */
    color: white;       /* Text color */
    cursor: pointer;    /* Pointer on hover */
    font-size: 14px;    /* Font size */
    transition: background-color 0.3s; /* Smooth transition */
}

/* Hover styles based on button color */
.hotel-popup button:hover {
    background-color: var(--button-hover-color); /* Hover color */
}

        .notifications {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            z-index: 9999;
        }
        .notifications .toast {
            max-width: 400px;
            border-radius: 4px;
            padding: 16px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: show_toast 0.3s ease forwards;
        }
        @keyframes show_toast {
            0% {
                transform: translateY(100%);
            }
            100% {
                transform: translateY(0);
            }
        }
        .toast::before {
            content: "";
            height: 3px;
            width: 100%;
            position: absolute;
            bottom: 0;
            left: 0;
            animation: progress 5s linear forwards;
            background: #E24D4C;
        }
        @keyframes progress {
            100% {
                width: 0%;
            }
        }
        .toast .column {
            display: flex;
            align-items: center;
        }
        .toast .column i {
            font-size: 1.5rem;
            color: #E24D4C;
        }
        .toast .column span {
            margin-left: 12px;
            font-size: 1rem;
            color: #34495E;
        }


        
    iframe {
        width: 100%;  /* Full width */
        border: none; /* Remove border */
        overflow: hidden; /* Disable scrollbars */
        border-radius: 5px; /* Rounded corners */
        margin-bottom: 10px;
       }



    </style>
</head>
<body>
    <div id="map"></div>
    <div id="locationButton" class="location-button" onclick="returnToLocation()">
  <i class="fas fa-crosshairs"></i>
</div>
    <div id="search-container">
        <i id="search-icon" class="fas fa-search"></i>
        <div id="search-input-container">
            <input type="text" id="search-input" placeholder="Search">
            <button id="clear-btn"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <ul class="notifications"></ul>
    <div id="map-overlay" class="map-overlay"></div>
    <div class="controls">
        <label>
            <input type="checkbox" id="fiveKCheckbox" checked>
            <span>5k</span>
        </label>
        <label>
            <input type="checkbox" id="juniorCheckbox" checked>
            <span>Junior</span>
        </label>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        
        
    
    function getCountryUrl(lat, lon) {
    const countries = {
        "3": { "url": "http://www.parkrun.com.au", "bounds": [113.654841, -43.163256, 153.578901, -12.376205] },
        "4": { "url": "http://www.parkrun.co.at", "bounds": [13.065462, 47.075123, 16.419671, 48.318131] },
        "14": { "url": "http://www.parkrun.ca", "bounds": [-123.650306, 42.990553, -57.937618, 56.733336] },
        "23": { "url": "http://www.parkrun.dk", "bounds": [8.442703, 55.474609, 12.635341, 56.987144] },
        "30": { "url": "http://www.parkrun.fi", "bounds": [23.759243, 60.177056, 25.732898, 65.015719] },
        "31": { "url": "http://www.parkrun.fr", "bounds": [-0.42901, 43.564162, 6.146281, 49.44128] },
        "32": { "url": "http://www.parkrun.com.de", "bounds": [6.084436, 47.586611, 13.762586, 53.70882] },
        "42": { "url": "http://www.parkrun.ie", "bounds": [-10.082041, 51.551575, -6.099962, 55.140535] },
        "44": { "url": "http://www.parkrun.it", "bounds": [9.211192, 37.621125, 18.166117, 45.694128] },
        "46": { "url": "http://www.parkrun.jp", "bounds": [130.673031, 31.908209, 141.125657, 39.692853] },
        "57": { "url": "http://www.parkrun.my", "bounds": [101.698056, 2.916852, 101.698056, 2.916852] },
        "64": { "url": "http://www.parkrun.co.nl", "bounds": [4.290593, 50.843369, 6.883689, 53.214822] },
        "65": { "url": "http://www.parkrun.co.nz", "bounds": [167.688869, -46.404097, 178.018082, -35.734968] },
        "67": { "url": "http://www.parkrun.no", "bounds": [5.322763, 58.952586, 11.068693, 63.430394] },
        "74": { "url": "http://www.parkrun.pl", "bounds": [14.25818, 49.548793, 23.48152, 54.598679] },
        "82": { "url": "http://www.parkrun.sg", "bounds": [103.762915, 1.294155, 103.893129, 1.360729] },
        "85": { "url": "http://www.parkrun.co.za", "bounds": [14.481783, -34.820522, 32.27309, -22.618415] },
        "88": { "url": "http://www.parkrun.se", "bounds": [11.943555, 55.60278, 20.249958, 63.826124] },
        "97": { "url": "http://www.parkrun.org.uk", "bounds": [-7.643103, 40.929141, 14.046913, 60.158081] },
        "98": { "url": "http://www.parkrun.us", "bounds": [-122.862376, 27.84707, -69.954915, 48.468375] }
    };

    for (let country in countries) {
        const { url, bounds } = countries[country];
        const [minLng, minLat, maxLng, maxLat] = bounds;

        if (lat >= minLat && lat <= maxLat && lon >= minLng && lon <= maxLng) {
            return url;
        }
    }

    return "http://www.parkrun.org.uk"; // Default URL if no match found
}


        function openUrl(url) {
            window.open(url, '_blank');
        }
        

        
function chooseAccommodation(lat, lon) {
    // Store the coordinates for use after the user makes a selection
    window.accommodationLat = lat;
    window.accommodationLon = lon;

    // Show the modal popup
    document.getElementById('accommodationModal').style.display = 'flex';
}


function handleAccommodationChoice(type) {
    const lat = window.accommodationLat;
    const lon = window.accommodationLon;

    if (type === 'hotels') {
        openHotelMap(lat, lon);
    } else if (type === 'campsites') {
        openCampsiteMap(lat, lon);
    }

    // Close the modal after selection
    closeAccommodationModal();
}

function closeAccommodationModal() {
    document.getElementById('accommodationModal').style.display = 'none';
}

function openCampsiteMap(lat, lon) {
    const url = `https://www.google.com/maps/search/Campsites/@${lat},${lon},18.5z`;
    window.open(url, '_blank');
}


        // Disable touch-and-hold context menus on mobile devices except for #search-container
        document.addEventListener('touchstart', function(e) {
            if (!e.target.closest('#search-container') && e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchend', function(e) {
            if (!e.target.closest('#search-container') && e.timeStamp - e.targetTouches[0].startTime > 500) {
                e.preventDefault();
            }
        });

        // Prevent holding mouse down or dragging with the mouse except on #search-container
        document.addEventListener('mousedown', function(e) {
            if (!e.target.closest('#search-container')) {
                e.preventDefault();
            }
        });

        // Prevent image dragging except on #search-container
        document.addEventListener('dragstart', function(e) {
            if (!e.target.closest('#search-container')) {
                e.preventDefault();
            }
        });

        // Disable right-click in Leaflet popups specifically, but allow on #search-container
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('.leaflet-popup-content') && !e.target.closest('#search-container')) {
                e.preventDefault(); // Prevent right-click in popups
            }
        });




        function getCityName(lat, lon) {
            return fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                .then(response => response.json())
                .then(data => data.address.city || data.address.village || data.address.town || 'Unknown');
        }
        
// Modify the map initialization to check URL parameters
const urlParams = new URLSearchParams(window.location.search);
const lat = parseFloat(urlParams.get('lat'));
const lon = parseFloat(urlParams.get('lon'));
const zoom = parseInt(urlParams.get('zoom')) || 13; 

const hasValidCoords = !isNaN(lat) && !isNaN(lon);

var map = L.map('map', {
    center: hasValidCoords ? [lat, lon] : [0, 0],
    zoom: hasValidCoords ? zoom : 2,
    zoomControl: false,
    maxBounds: [[-90, -180], [90, 180]],
    maxBoundsViscosity: 1.0,
    minZoom: 2,
    worldCopyJump: false
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
    maxZoom: 19
}).addTo(map);

// Function to update URL with current map position
function updateURL() {
    const center = map.getCenter();
    const zoom = map.getZoom();
    const newUrl = `${window.location.pathname}?lat=${center.lat.toFixed(6)}&lon=${center.lng.toFixed(6)}&zoom=${zoom}`;
    window.history.replaceState({}, '', newUrl);
}

map.on('moveend', updateURL);

var userLocationMarker;

// Function to handle location found
function onLocationFound(e) {
    if (!userLocationMarker) {
        userLocationMarker = L.marker(e.latlng, { icon: LocationIcon }).addTo(map)
            .bindPopup("You are here");
    } else {
        userLocationMarker.setLatLng(e.latlng);
    }

    if (!hasValidCoords) {
        map.setView(e.latlng, 13);
    }
}

map.on('locationfound', onLocationFound);

// Only locate user if no valid coordinates are provided in the URL
if (!hasValidCoords) {
    map.locate({ setView: true, maxZoom: 13 });
} else {
    map.locate({ setView: false }); // Detect user location but donâ€™t move map
}


// Use the merged function in the location found event
//.on('locationfound', onLocationFound);

// Listen for map movements to update URL
map.on('moveend', updateURL);

        var juniorIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/Icons/Junior.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });

        var fiveKIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/Icons/5k.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });

        var LocationIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/Icons/Me.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });
        
        var bbIcon = L.icon({
           iconUrl: 'https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/Icons/BB.png',  // Replace with actual icon URL
           iconSize: [38, 38],
           iconAnchor: [19, 38],
           popupAnchor: [0, -38]
        });

        
        var canceledIcon = L.icon({
           iconUrl: 'https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/Icons/Cancel.png',
           iconSize: [38, 38],
           iconAnchor: [19, 38],
           popupAnchor: [0, -38]
        });
        
        //here

var bbMarkers = []; // Array to store BB markers
var data = {};
var cancellations = {};
var markers = L.markerClusterGroup(); // Cluster for other markers

// Function to normalize event names
function normalizeEventName(name) {
    if (!name) return '';  // Handle potential null/undefined names
    return name.toLowerCase().replace(/\s+/g, '').replace('parkrun', '');
}

// Function to fetch location data
async function fetchLocationData() {
    const url = 'https://raw.githubusercontent.com/ALD-Models/Testing/refs/heads/main/BBS/Locations.json';
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        return data.locations; // Access the locations array
    } catch (error) {
        console.error('Failed to fetch the location data:', error);
        return null;
    }
}

function addMarkersToMap(locations) {
    locations.forEach(location => {
        const lat = location.coordinates.latitude;
        const lon = location.coordinates.longitude;
        const name = location.name;
        const description = location.description;
        const phone = location.phone;
        const website = location.website;
        const image = location.image_link;

        // Create marker with BB icon
        const bbMarker = L.marker([lat, lon], { icon: bbIcon })
            .bindPopup(
                `<div style="width: 200px;">
                    <img src="${image}" alt="${name}" style="width: 100%; height: auto; border-top-left-radius: 10px; border-top-right-radius: 10px;">
                    <div style="padding: 10px;">
                        <b>${name}</b><br>
                        ${description}<br>
                        <a href="${website}" target="_blank" style="text-decoration: none;">
                            <button class="hotel-btn" style="background-color: #f67d00; color: white; width: 100%; margin: 5px 0; border: none; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-globe"></i> Visit Website
                            </button>
                        </a>
                        <button class="hotel-btn" style="background-color: #f67d00; color: white; width: 100%; margin: 5px 0; border: none; border-radius: 5px; cursor: pointer;" onclick="window.location.href='tel:${phone}'">
                            <i class="fas fa-phone"></i> ${phone}
                        </button>
                    </div>
                </div>`
            );

        // Store the BB marker
        bbMarkers.push(bbMarker);
    });
    
    updateMarkerVisibility(); // Check visibility after adding markers
}

// Function to update BB marker visibility based on zoom level
function updateMarkerVisibility() {
    if (map.getZoom() < 13) {
        bbMarkers.forEach(marker => {
            map.removeLayer(marker); // Remove BB markers when zoomed out
        });
    } else {
        bbMarkers.forEach(marker => {
            map.addLayer(marker); // Add BB markers when zoomed in
        });
    }
}

// Add other markers to the map (if any)
function addOtherMarkersToMap(otherLocations) {
    otherLocations.forEach(location => {
        const lat = location.coordinates.latitude;
        const lon = location.coordinates.longitude;
        const marker = L.marker([lat, lon]); // Other markers without specific icon
        markers.addLayer(marker); // Add to cluster
    });
    map.addLayer(markers); // Add the cluster to the map
}

// Event listener for zoom change
map.on('zoomend', updateMarkerVisibility);



//to here
var userLocationMarker; // Variable to hold the user's location marker
  var locationButton = document.getElementById("locationButton");

  // Automatically locate the user on map load
  //map.locate({ setView: true, maxZoom: 13 });

  // Function to relocate to the user's current location
function returnToLocation() {
    if (userLocationMarker) {
        // Instantly pan to last known location
        map.flyTo(userLocationMarker.getLatLng(), 13, { duration: 1.5 });

        /* Then request a fresh location update (doesn't move the map instantly)
        map.locate({ setView: false, maxZoom: 13 });*/
    } else {
        // If no known location, request it and center when found
        map.locate({ setView: true, maxZoom: 13 });
    }
}

  

let canCreateToast = true;

map.on('locationerror', function() {
  if (canCreateToast) {
    createToast();
    canCreateToast = false;
    setTimeout(function() {
      canCreateToast = true;
    }, 10000); // 10 seconds
  }
});


  // Show the button when the map moves away from the user's location
  map.on('moveend', function() {
    if (userLocationMarker) {
      // Check if the user's location is within the current view
      var bounds = map.getBounds();
      var isUserLocationVisible = bounds.contains(userLocationMarker.getLatLng());

      // Show the button only if the user's location is not visible
      locationButton.style.display = isUserLocationVisible ? "none" : "block";
    }
  });

        const notifications = document.querySelector(".notifications");

        const toastDetails = {
            timer: 5000, // 5 seconds timer
            error: {
                icon: 'fa-triangle-exclamation',
                text: 'Unable to find your location',
            }
        };

        const removeToast = (toast) => {
            toast.classList.add("hide");
            setTimeout(() => toast.remove(), 500);
        }

        const createToast = () => {
            const { icon, text } = toastDetails.error;
            const toast = document.createElement("li");
            toast.className = `toast`;
            toast.innerHTML = `<div class="column">
                                 <i class="fa-solid ${icon}"></i>
                                 <span>${text}</span>
                              </div>`;
            notifications.appendChild(toast);
            setTimeout(() => {
                removeToast(toast);
            }, toastDetails.timer);
        }


    // Fetch location data and add to the map
    fetchLocationData().then(data => {
        if (data && Array.isArray(data)) {
            addMarkersToMap(data);
        } else {
            console.error('Invalid location data');
        }
    });

function fetchLocationCoordinates(place) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
    return fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                const location = data[0];
                return {
                    lat: parseFloat(location.lat),
                    lon: parseFloat(location.lon),
                    boundingBox: location.boundingbox.map(coord => parseFloat(coord)), // [south, north, west, east]
                };
            }
            throw new Error("Location not found");
        });
}


 
// Fetch cancellation data
fetch('https://raw.githubusercontent.com/ALD-Models/Testing/main/cancellations.json')
    .then(response => response.json())
    .then(data => {
        cancellations = {};
        data.forEach(item => {
            let normalizedKey = normalizeEventName(item.name);
            cancellations[normalizedKey] = item.reason;
        });
        updateMapMarkers();
    })
    .catch(err => console.error('Error fetching cancellation data:', err));

// Function to update map markers
function updateMapMarkers() {
    markers.clearLayers();

    if (!data.events) return;

    data.events.features.forEach(function (feature) {
        if (feature.geometry.type === 'Point') {
            var coordinates = feature.geometry.coordinates;
            var eventname = normalizeEventName(feature.properties.eventname);
            var eventLongName = feature.properties.EventLongName;


            var isJunior = eventLongName.toLowerCase().includes('junior');
            var showMarker = (isJunior && document.getElementById('juniorCheckbox').checked) ||
                (!isJunior && document.getElementById('fiveKCheckbox').checked);

            if (showMarker) {
                var countryUrl = getCountryUrl(coordinates[1], coordinates[0]);

                // Default popup content
                var popupContent = `
                    <div>
                        <div class="popup-title">${eventLongName}</div>
                        <iframe id="weatherIframe" src="https://parkrunnertourist.co.uk/weather?lat=${coordinates[1]}&lon=${coordinates[0]}" scrolling="no"></iframe>
                        <button class="course-btn" onclick="openUrl('${countryUrl}/${eventname}/course/')">Course</button><br>
                        <button class="volunteer-btn" onclick="openUrl('${countryUrl}/${eventname}/futureroster/')">Volunteer</button><br>
                        <button class="direction-btn" onclick="openDirections(${coordinates[1]}, ${coordinates[0]})">Directions</button><br>
                    </div>
                `;

                // Check if the event is canceled
                var markerIcon = isJunior ? juniorIcon : fiveKIcon; // Default icon
                if (cancellations[eventname]) {
                    popupContent = `
                        <div>
                            <div class="popup-title">${eventLongName}</div>
                            <div style="color: red; font-weight: bold;">Cancelled: ${cancellations[eventname]}</div>
                            <button class="course-btn" onclick="openUrl('${countryUrl}/${eventname}/course/')">Course</button><br>
                            <button class="volunteer-btn" onclick="openUrl('${countryUrl}/${eventname}/futureroster/')">Volunteer</button><br>
                            <button class="direction-btn" onclick="openDirections(${coordinates[1]}, ${coordinates[0]})">Directions</button><br>
                        </div>
                    `;
                    markerIcon = canceledIcon; // Change to canceled icon
                }

                // Create the marker
                var marker = L.marker([coordinates[1], coordinates[0]], { icon: markerIcon })
                    .bindPopup(popupContent);

                // Attach the click event to find nearby hotels and campsites
                marker.on('click', function () {
                    console.log(`Marker clicked at: ${coordinates[1]}, ${coordinates[0]}`);
                    findNearbyPlaces(coordinates[1], coordinates[0]); // Show hotels and campsites
                });

                markers.addLayer(marker);
            }
        }
    });

    map.addLayer(markers);
}



// TomTom API Key
const tomTomApiKey = 'dAvRoz8Z1SA4K6JM5l6XnJMGPwc7GQmG';

// Define custom icons
const hotelIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/ALD-Models/Testing/main/Icons/Hotel.png',
    iconSize: [38, 38],
    iconAnchor: [19, 38],
    popupAnchor: [0, -38],
});

const campsiteIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/ALD-Models/Testing/main/Icons/Camp.png',
    iconSize: [38, 38],
    iconAnchor: [19, 38],
    popupAnchor: [0, -38],
});

// Function to search for nearby hotels and campsites using TomTom
function findNearbyPlaces(lat, lng) {
    console.log(`Searching for hotels and campsites near: ${lat}, ${lng}`);

    // Search for hotels
    fetchTomTomPlaces(lat, lng, 'hotel', hotelIcon);

    // Search for campsites
    fetchTomTomPlaces(lat, lng, 'camping', campsiteIcon);
}

// Function to fetch hotels or campsites from TomTom API
function fetchTomTomPlaces(lat, lng, category, icon) {
    const searchUrl = `https://api.tomtom.com/search/2/categorySearch/${category}.json?lat=${lat}&lon=${lng}&radius=9000&key=${tomTomApiKey}`;

    fetch(searchUrl)
        .then(response => response.json())
        .then(data => {
            console.log(`TomTom ${category} API Response:`, data);

            if (data.results && data.results.length > 0) {
                data.results.forEach(place => {
                    createPlaceMarker(place, category, icon);
                });
            } else {
                console.log(`No ${category}s found within 9km.`);
            }
        })
        .catch(error => console.error(`Error fetching ${category} data:`, error));
}

// Function to create a marker for a place and bind a popup
function createPlaceMarker(place, type, icon) {
    const lat = place.position.lat;
    const lon = place.position.lon;
    const name = place.poi?.name || "No Name Available";
    const address = place.address?.freeformAddress || "Address not available";
    const phoneNumber = place.poi?.phone || null;
    const websiteUrl = place.poi?.url || null;
    const imageUrl = place.poi?.imageUrl || null;

    // Define button colors based on place type
    const buttonColor = type === "camping" ? "#0d7640" : "#c8a367";
    const buttonHoverColor = type === "camping" ? "#0a5a30" : "#b0874e";

    // Create popup content
    let popupContent = `
        <div class="hotel-popup" style="--button-color: ${buttonColor}; --button-hover-color: ${buttonHoverColor}">
            <div class="popup-title">${name}</div>
    `;

    // If there's an image, add it to the popup content
    if (imageUrl) {
        popupContent += `<img src="${imageUrl}" alt="${name}" class="hotel-popup-image" />`;
    }

popupContent += `
    <button onclick="openDirections(${lat}, ${lon})">
        <i class="fas fa-map-marker-alt"></i> Directions
    </button>
    ${websiteUrl ? `
        <button onclick="openWebsite('${websiteUrl}')">
            <i class="fas fa-globe"></i> Visit Website
        </button>
    ` : `
        <button disabled><i class="fas fa-globe"></i> No Website</button>
    `}
    ${phoneNumber ? `
        <a href="tel:${phoneNumber}">
            <button><i class="fas fa-phone"></i> Call</button>
        </a>
    ` : `
        <button disabled><i class="fas fa-phone"></i> No Phone</button>
    `}
</div>
`;

    // Add marker to the map
    L.marker([lat, lon], { icon }).bindPopup(popupContent).addTo(map);
}




// Initial fetch for data and event listener setup
fetch('https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/events1.json')
    .then(response => response.json())
    .then(jsonData => {
        data = jsonData;
        updateMapMarkers();

        document.getElementById('juniorCheckbox').addEventListener('change', updateMapMarkers);
        document.getElementById('fiveKCheckbox').addEventListener('change', updateMapMarkers);
    })
    .catch(err => console.error('Error fetching GeoJSON:', err));

        window.addEventListener('load', () => {
    const consentButton = document.querySelector('.VfPpkd-RLmnJb');
    if (consentButton) {
        consentButton.click();
    }
});


        function openDirections(lat, lon) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
            window.open(url, '_blank');
        }

        function openHotelMap(lat, lon) {
           const url = `https://www.google.com/maps/search/Hotels/@${lat},${lon},18.5z`;
           window.open(url, '_blank');
        }
        
function openWebsite(url) {
    // Ensure the website URL is an absolute URL (with http:// or https://)
    if (!/^https?:\/\//i.test(url)) {
        url = 'https://' + url; // Add https:// if no protocol is provided
    }
    window.open(url, '_blank');
}



        

// Assuming userLocationMarker is defined globally to store the user's location marker
var userLocationMarker = null;
var locationCircle = null; // To show accuracy radius circle around the user location



        function onLocationError(e) {
           // alert(e.message);
        }

        //map.on('locationfound', onLocationFound);
        //map.on('locationerror', onLocationError);

        //map.locate({setView: true, maxZoom: 13});


    document.getElementById('search-icon').addEventListener('click', function() {
    var input = document.getElementById('search-input');
    var clearBtn = document.getElementById('clear-btn');
    var searchIcon = document.getElementById('search-icon');
    input.classList.toggle('show');
    clearBtn.style.display = input.classList.contains('show') ? 'block' : 'none';
    searchIcon.classList.toggle('hidden', input.classList.contains('show')); // Add this line
    input.focus();
            
        });

document.getElementById('clear-btn').addEventListener('click', function() {
    var input = document.getElementById('search-input');
    var searchIcon = document.getElementById('search-icon');
    input.value = '';
    input.classList.remove('show');
    this.style.display = 'none';
    searchIcon.classList.remove('hidden'); // Ensure the icon is visible
    updateMapMarkers();
        });



        
function debounce(func, delay) {
    let timer;
    return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => func.apply(this, args), delay);
    };
}



document.getElementById('search-input').addEventListener(
    'input',
    debounce(function () {
        const searchValue = this.value.trim().toLowerCase();
        markers.clearLayers(); // Clear all markers

        if (searchValue) {
            // Step 1: Search for the place first
            fetchLocationCoordinates(searchValue)
                .then(({ lat, lon, boundingBox }) => {
                    const [south, north, west, east] = boundingBox;

                    // Display parkruns within the bounding box
                    const filteredMarkers = [];
                    data.events.features.forEach(feature => {
                        if (feature.geometry.type === 'Point') {
                            const [lonEvent, latEvent] = feature.geometry.coordinates;
                            const eventLongName = feature.properties.EventLongName.toLowerCase();

                            // Determine if the event is a junior parkrun
                            const isJunior = eventLongName.includes('junior');
                            const markerIcon = isJunior ? juniorIcon : fiveKIcon; // Use appropriate marker icon

                            if (
                                latEvent >= south &&
                                latEvent <= north &&
                                lonEvent >= west &&
                                lonEvent <= east
                            ) {
                                const eventname = feature.properties.eventname;

                                const popupContent = `
                                    <div>
                                        <div class="popup-title">${feature.properties.EventLongName}</div>
                                        <iframe id="weatherIframe" src="https://parkrunnertourist.co.uk/weather?lat=${latEvent}&lon=${lonEvent}" scrolling="no"></iframe>
                                        <button class="course-btn" onclick="openUrl('https://www.parkrun.org.uk/${eventname}/course/')">Course</button><br>
                                        <button class="volunteer-btn" onclick="openUrl('https://www.parkrun.org.uk/${eventname}/futureroster/')">Volunteer</button><br>
                                        <button class="direction-btn" onclick="openDirections(${latEvent}, ${lonEvent})">Directions</button><br>
                                    </div>
                                `;

                                const marker = L.marker([latEvent, lonEvent], { icon: markerIcon })
                                    .bindPopup(popupContent)
                                    .on('click', function () {
                                        // Trigger nearby places search on marker click
                                        findNearbyPlaces(latEvent, lonEvent);
                                    });

                                // Add marker to cluster group after attaching the click event
                                markers.addLayer(marker);
                                filteredMarkers.push(marker);
                            }
                        }
                    });

                    if (filteredMarkers.length > 0) {
                        map.addLayer(markers);
                        const group = L.featureGroup(filteredMarkers);
                        map.fitBounds(group.getBounds());
                    } else {
                        displayNoResultsMessage(); // Notify when no parkruns found
                    }
                })
                .catch(err => {
                    console.warn("Location not found:", err);

                    // Step 2: Fallback to event name search
                    const matchingEvents = [];
                    data.events.features.forEach(function (feature) {
                        if (feature.geometry.type === 'Point') {
                            const eventLongName = feature.properties.EventLongName.toLowerCase();
                            const isJunior = eventLongName.includes('junior');
                            const markerIcon = isJunior ? juniorIcon : fiveKIcon; // Use appropriate marker icon

                            if (eventLongName.includes(searchValue)) {
                                matchingEvents.push({ feature, markerIcon });
                            }
                        }
                    });

                    if (matchingEvents.length > 0) {
                        const filteredMarkers = matchingEvents.map(({ feature, markerIcon }) => {
                            const [lonEvent, latEvent] = feature.geometry.coordinates;
                            const eventname = feature.properties.eventname;

                            const popupContent = `
                                <div>
                                    <div class="popup-title">${feature.properties.EventLongName}</div>
                                    <iframe id="weatherIframe" src="https://parkrunnertourist.co.uk/weather?lat=${latEvent}&lon=${lonEvent}" scrolling="no"></iframe>
                                    <button class="course-btn" onclick="openUrl('https://www.parkrun.org.uk/${eventname}/course/')">Course</button><br>
                                    <button class="volunteer-btn" onclick="openUrl('https://www.parkrun.org.uk/${eventname}/futureroster/')">Volunteer</button><br>
                                    <button class="direction-btn" onclick="openDirections(${latEvent}, ${lonEvent})">Directions</button><br>
                                </div>
                            `;

                            const marker = L.marker([latEvent, lonEvent], { icon: markerIcon })
                                .bindPopup(popupContent)
                                .on('click', function () {
                                    findNearbyPlaces(latEvent, lonEvent);
                                });

                            markers.addLayer(marker);
                            return marker;
                        });

                        map.addLayer(markers);

                        if (matchingEvents.length === 1) {
                            const [lon, lat] = matchingEvents[0].feature.geometry.coordinates;
                            map.setView([lat, lon], 15);
                        } else {
                            const group = L.featureGroup(filteredMarkers);
                            map.fitBounds(group.getBounds());
                        }
                    } else {
                        displayNoResultsMessage(); // Notify when no matching events
                    }
                });
        } else {
            updateMapMarkers(); // Reset markers if the search is cleared
        }
    }, 500)
);


function displayNoResultsMessage() {
    const input = document.getElementById('search-input');
    
    input.style.borderColor = '#FFC107'; 
    input.style.boxShadow = '0 0 8px #FFC107';
    input.style.borderWidth = '2px';

    // Reset styles after 3 seconds
    setTimeout(() => {
        input.style.borderColor = '';
        input.style.boxShadow = '';
        input.style.borderWidth = '';
    }, 3000);
}
    </script>
    
</body>
</html>
